
#(a)
```{r}
# Test example:
 A <- c(1, 1, 1, 1, 0, 0, 0, 0, 0)
 mrate <- c(11, 14, 24, 20, 26, 20, 3, 7, 8)
 hcover =c(0.06,0.07,0.06,0.07,0.07,0.06, 0.02,0.02,0.01)
 pcdocs =c(0.02, 0.01,0.02,0.01,0.02,0.01,0.04,0.04,0.05)
 M = data.frame(A,mrate,hcover,pcdocs)
 
propscorematch <- function(data, formula, y) {
  # create model
  model <- glm(formula, data = data, family = binomial(link = "logit"))
  # propensity scores
  prop_score <- model$fitted
  # dataframe
  df <- cbind(data, prop_score)
  # initialize match and controls
  matches <- list()
  controls <- which(y == 0)
  
  # find matches with greedy rule
  for (i in which(y == 1)) {
    prop_diff <- abs(prop_score[i] - df$prop_score[controls])
    greed <- controls[which.min(prop_diff)]
    matches[[i]] <- c(i, greed)
    controls <- which(y == 0) # allows for repeat
    controls <- controls[-which(controls == greed)]
  }
  return(list(Match.pairs = matches, Propensity = prop_score))
}
# Test example:
result_a = propscorematch(data = M, formula = A ~ hcover + pcdocs, y = M$A)
print(result_a$Match.pairs)
print(result_a$Propensity)
```

#(b)
```{r}
# input paramater response has to be a vector
calculate_ate <- function(response, match_pairs) {
  # Split treatment and control groups using match pairs list
  treatment_row <- sapply(match_pairs, function(x) x[1])
  control_row <- sapply(match_pairs, function(x) x[2])
  treatment_group <- response[treatment_row]
  control_group <- response[control_row]
  
  # Calculate the average treatment effect (ATE)
  ate <- mean(treatment_group) - mean(control_group)
  
  # Standard error for ATE
  n <- length(match_pairs)
  n_treatment <- length(treatment_group)
  n_control <- length(control_group)
  sd <- sqrt(var(treatment_group) / n_treatment + var(control_group) / n_control)
  standard_error <- sd / sqrt(n)
  
  # Statistic scores
  t_stat <- ate / standard_error
  df <- n - 1
  p_value <- 2 * pt(-abs(t_stat), df)
  
  # Return the results
  return(list(ATE = ate, Sd.Error = standard_error, t.stat = t_stat, p.value = p_value))
}
# Test example:
# result = calculate_ate(M$mrate, match)
# print(result$ATE)
# print(result$p.value)
match = propscorematch(data = M, formula = A ~ hcover + pcdocs, y = M$A)$Match.pairs #from Ethan's function
# How to implement this function:
result_b = calculate_ate(M$mrate, match)
print(result$ATE)

```

#(c)
```{r}
#prop_score should be the glm model
#var: string, name of the interest variable
#propens_col: string, name of the propensity col
quality_plots_smd <- function(data, match_pairs, prop_scores, var_col)
{
  treatment_row <- sapply(match_pairs, function(x) x[1])
  control_row <- sapply(match_pairs, function(x) x[2])
  
  prop_score_control <- prop_scores[control_row]
  prop_score_treat <- prop_scores[treatment_row]
  
  hist_prop_score_control <- hist(prop_score_control)
  hist_prop_score_treat <- hist(prop_score_treat)
  hist_prop_score_control$counts <- -hist_prop_score_control$counts
  #TODO: color
  plot(hist_prop_score_treat, xlim=c(0,1), ylim=c(-50,50),
       main="Histograms of Propensity Scores by Treatment",
       xlab="Propensity Scores", col="blue")
  lines(hist_prop_score_control, col="red")
  legend("topright", "Treatment 1", "Treatment 0",
         fill=c("blue", "red"), cex=0.5)
  
  var_control <- data[, var_col][control_row]
  var_treat <- data[, var_col][treatment_row]
  
  numer <- abs(mean(var_treat) - mean(var_control))
  denom <- sqrt((sd(var_treat)^2 + sd(var_control)^2)/2)
  smd <- numer/denom
  return(smd)
}
# Test example:
match = propscorematch(data = M, formula = A ~ hcover + pcdocs, y = M$A)$Match.pairs
prop = propscorematch(data = M, formula = A ~ hcover + pcdocs, y = M$A)$Propensity
example_mrate <- quality_plots_smd(M, match, prop, 2)
```

#(d)
```{r}
# Combining into one mega function
propensity_score_match <- function(data, formula, treatment_col, response_col) {
  match = propscorematch(data, A ~ hcover + pcdocs, y = data[treatment_col])$Match.pairs
  prop_score = propscorematch(data, A ~ hcover + pcdocs, y = data[treatment_col])$Propensity
  ate_scores = calculate_ate(data[,response_col], match)
  smd = quality_plots_smd(data, match, prop_score, response_col)
  return(list(Matching.pairs = match, Propensity = prop_score, ATE.scores = ate_scores, SMD = smd))
}

# Test example:
A = c(1, 1, 1, 1, 0, 0, 0, 0, 0)
mrate = c(11, 14, 24, 20, 26, 20, 3, 7, 8)
hcover = c(0.06,0.07,0.06,0.07,0.07,0.06, 0.02,0.02,0.01)
pcdocs = c(0.02, 0.01,0.02,0.01,0.02,0.01,0.04,0.04,0.05)
M = data.frame(A,mrate,hcover,pcdocs)
result = propensity_score_match(data=M, formula=A ~ hcover + pcdocs, treatment_col = 1, response_col = 2)
print(result$Matching.pairs)
print(result$ATE.results)
print(result$SMD)

```
